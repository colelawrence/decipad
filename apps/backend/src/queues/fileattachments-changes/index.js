var y=Object.create;var i=Object.defineProperty,x=Object.defineProperties,N=Object.getOwnPropertyDescriptor,b=Object.getOwnPropertyDescriptors,O=Object.getOwnPropertyNames,a=Object.getOwnPropertySymbols,P=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable;var d=(e,t,n)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,m=(e,t)=>{for(var n in t||(t={}))c.call(t,n)&&d(e,n,t[n]);if(a)for(var n of a(t))u.call(t,n)&&d(e,n,t[n]);return e},S=(e,t)=>x(e,b(t)),C=e=>i(e,"__esModule",{value:!0}),s=(e,t)=>i(e,"name",{value:t,configurable:!0});var A=(e,t)=>{var n={};for(var r in e)c.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&a)for(var r of a(e))t.indexOf(r)<0&&u.call(e,r)&&(n[r]=e[r]);return n};var K=(e,t)=>{C(e);for(var n in t)i(e,n,{get:t[n],enumerable:!0})},R=(e,t,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of O(t))!c.call(e,r)&&r!=="default"&&i(e,r,{get:()=>t[r],enumerable:!(n=N(t,r))||n.enumerable});return e},E=e=>R(C(i(e!=null?y(P(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);K(exports,{handler:()=>k});var h=E(require("assert"));function _(e){return async t=>{for(let n of t.Records){let r=JSON.parse(n.body);try{await e(r)}catch(D){console.error("Error processing queue element: %j",r),console.error(D)}}return{statusCode:200}}}s(_,"queueHandler");var l=E(require("aws-sdk/clients/s3"));var p=E(require("assert"));function I(){return{endpoint:o("DECI_S3_ENDPOINT","localhost:4568"),accessKeyId:o("DECI_S3_ACCESS_KEY_ID"),secretAccessKey:o("DECI_S3_SECRET_ACCESS_KEY"),buckets:{pads:o("DECI_S3_PADS_BUCKET"),attachments:o("DECI_S3_ATTACHMENTS_BUCKET")}}}s(I,"s3");function g(){return{urlBase:o("DECI_APP_URL_BASE","http://localhost:4200"),limits:{maxAttachmentSize:Number(o("DECI_MAX_ATTACHMENT_SIZE","10485760")),maxAttachmentUploadTokenExpirationSeconds:Number(o("DECI_MAX_ATTACHMENT_UPLOAD_TOKEN_EXPIRATION_SECONDS","600")),maxAttachmentDownloadTokenExpirationSeconds:Number(o("DECI_MAX_ATTACHMENT_DOWNLOAD_TOKEN_EXPIRATION_SECONDS","600"))}}}s(g,"app");function o(e,t=void 0){let n=process.env[e];return n==null&&(t!==void 0?n=t:(0,p.fail)(`${e} env var must be defined`)),n}s(o,"env");var f=I(),{buckets:w}=f,v=A(f,["buckets"]),H=S(m({},v),{sslEnabled:process.env.NODE_ENV!=="testing",s3ForcePathStyle:!0,signatureVersion:"v4"}),M=w.attachments,U=new l.default(H),{limits:{maxAttachmentSize:G,maxAttachmentUploadTokenExpirationSeconds:Y,maxAttachmentDownloadTokenExpirationSeconds:V}}=g();async function T(e){e.startsWith("/")&&(e=e.substring(1)),await U.deleteObject({Bucket:M,Key:e})}s(T,"remove");var k=_(B);async function B(e){let{table:t,action:n,recordBeforeDelete:r}=e;h.default.equal(t,"fileattachments"),n==="delete"&&(!r||await T(r.filename))}s(B,"attachmentsChangesHandler");0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
